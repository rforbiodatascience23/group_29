---
title: "Survival Analysis"
format: html
editor: visual
---

## Loading packages

```{r}
library(survival)
library(broom)
library(forestplot)
library(survminer)
library(purrr)
```

## Loading the data

```{r}
TCGA_aug <- as.data.frame(read_tsv("./../data/03_dat_aug.tsv", show_col_types = FALSE))
```

## **Create the Survival Object**

First, ensure that the dataset (**`TCGA_aug`**) has the necessary variables for survival analysis. Typically, we need:

-   A time-to-event variable: This could be the **`OS.time`** or **`DSS.time`** in the dataset, representing the time until the event (death) occurs.

-   An event indicator: This could be the **`OS`** or **`DSS`** variable, indicating whether the event (death) has occurred (1) or not (0/censored).

Create a **`Surv`** object, which is a special type of object used by the survival package:

```{r}

# Ensure cancer_type and stage is treated as a factor
TCGA_aug$cancer_type <- as.factor(TCGA_aug$cancer_type)
TCGA_aug$stage_group <- as.factor(TCGA_aug$stage_group)

# OS.time is the time variable and OS is the event indicator
surv_obj <- Surv(time = TCGA_aug$OS.time, event = TCGA_aug$OS)
```

## **Fit the cox proportional hazards model**

Fit the model using the **`coxph`** function. Select predictors based on the understanding of the data and previous analyses.

```{r}
# Fit a Cox proportional hazards model
cox_model <- coxph(surv_obj ~ strata(cancer_type) + age_diagnosis + 
                     gender + race, data = TCGA_aug)
```

## Model summary

Inspect the model output to understand the impact of predictors:

```{r}
summary(cox_model)
```

## **Checking Proportional Hazards Assumption**

The Cox model assumes that the ratio of hazards (risk) is constant over time (proportional hazards). This assumption should be checked:

```{r}
# Checking Proportional Hazards assumption
cox.zph(cox_model)

```

## **Visualizing the Results**

Use the **`ggplot2`** package to visualize the results, such as plotting the estimated survival curves:

```{r}
# Survival plot

# Use survfit() to generate survival curves for the fitted model
fit_surv <- survfit(cox_model)

# Plot survival curves without p-values and confidence intervals
survival_plot <- ggsurvplot(fit_surv, data = TCGA_aug, ggtheme = theme_minimal(),
           xlab = "Time", ylab = "Survival probability",
           test.for.trend = T, legend = "right")

```
